<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SPI Marine Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
--bg:#020617;
--text:#e5e7eb;
--border:#1f2937;
--mono:"SF Mono",Menlo,Consolas,monospace;
--alert-red:#7f1d1d;
--alert-yellow:#facc15;
  --bg:#020617;
  --text:#e5e7eb;
  --mono:"SF Mono",Menlo,Consolas,monospace;
  --alert-red:#7f1d1d;
  --alert-yellow:#facc15;
}

/* FULLSCREEN CANVAS */
body {
margin:0;
width:100vw;
height:100vh;
overflow:hidden;
background:radial-gradient(circle at top,#1e293b 0,#020617 55%);
color:var(--text);
font-family:var(--mono);
display:flex;
justify-content:center;
align-items:center;
  margin:0;
  width:100vw;
  height:100vh;
  overflow:hidden;
  background:radial-gradient(circle at top,#1e293b 0,#020617 55%);
  color:var(--text);
  font-family:var(--mono);
  display:flex;
  justify-content:center;
  align-items:center;
}

/* MAIN BOARD */
.board {
width:100%;
height:100%;
padding:4vh 4vw;
box-sizing:border-box;
display:flex;
flex-direction:column;
gap:5vh;
  width:100%;
  height:100%;
  padding:4vh 4vw;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  gap:5vh;
}

/* TOP BAR */
.title {
display:flex;
justify-content:space-between;
align-items:center;
font-size:clamp(2rem,4vw,4rem);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:clamp(2rem,4vw,4rem);
}

/* MAIN GRID */
.grid {
flex:1;
width:100%;
display:grid;
grid-template-columns: 1fr 1fr 1fr 1fr;

row-gap:4vh;
column-gap:4vw;

font-size:clamp(1.4rem,2.8vw,3.2rem);
  flex:1;
  width:100%;
  display:grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  row-gap:4vh;
  column-gap:4vw;
  font-size:clamp(1.4rem,2.8vw,3.2rem);
}

.cell { white-space:nowrap; }

/* ALERT COLORS */
.alert-red {
background:var(--alert-red);
color:black !important;
padding:0.25em 0.4em;
border-radius:6px;
width:100%;
display:inline-block;
  background:var(--alert-red);
  color:black !important;
  padding:0.25em 0.4em;
  border-radius:6px;
  width:100%;
  display:inline-block;
}

.alert-yellow {
background:var(--alert-yellow);
color:black !important;
padding:0.25em 0.4em;
border-radius:6px;
width:100%;
display:inline-block;
  background:var(--alert-yellow);
  color:black !important;
  padding:0.25em 0.4em;
  border-radius:6px;
  width:100%;
  display:inline-block;
}
</style>
</head>

<body>
<div class="board">
<div class="title">
<div>WEATHER</div>
<div id="updatedAt">LOADING…</div>
</div>

<div class="grid">

<div class="cell"></div>
<div class="cell">GULF</div>
<div class="cell">BAY</div>
<div class="cell">TIDES: <span id="tideDate"></span></div>

<div class="cell"><span id="waterLabel">WATER</span></div>
<div class="cell"><span id="gulfWater">--</span></div>
<div class="cell"><span id="bayWater">--</span></div>
<div class="cell">LOW: <span id="tideLow">--</span></div>

<div class="cell"><span id="airLabel">AIR</span></div>
<div class="cell"><span id="gulfAir">--</span></div>
<div class="cell"><span id="bayAir">--</span></div>
<div class="cell">HIGH: <span id="tideHigh">--</span></div>

<div class="cell"><span id="windLabel">WIND</span></div>
<div class="cell"><span id="gulfWind">--</span></div>
<div class="cell"><span id="bayWind">--</span></div>
<div class="cell">SUNRISE: <span id="sunrise">--</span></div>

<div class="cell"><span id="seasLabel">SEAS</span></div>
<div class="cell"><span id="gulfSeas">--</span></div>
<div class="cell"><span id="baySeas">N/A</span></div>
<div class="cell">SUNSET: <span id="sunset">--</span></div>

</div>
  <div class="title">
    <div>WEATHER</div>
    <div id="updatedAt">LOADING…</div>
  </div>

  <div class="grid">

    <div class="cell"></div>
    <div class="cell">GULF</div>
    <div class="cell">BAY</div>
    <div class="cell">TIDES: <span id="tideDate"></span></div>

    <div class="cell"><span id="waterLabel">WATER</span></div>
    <div class="cell"><span id="gulfWater">--</span></div>
    <div class="cell"><span id="bayWater">--</span></div>
    <div class="cell">LOW: <span id="tideLow">--</span></div>

    <div class="cell"><span id="airLabel">AIR</span></div>
    <div class="cell"><span id="gulfAir">--</span></div>
    <div class="cell"><span id="bayAir">--</span></div>
    <div class="cell">HIGH: <span id="tideHigh">--</span></div>

    <div class="cell"><span id="windLabel">WIND</span></div>
    <div class="cell"><span id="gulfWind">--</span></div>
    <div class="cell"><span id="bayWind">--</span></div>
    <div class="cell">SUNRISE: <span id="sunrise">--</span></div>

    <div class="cell"><span id="seasLabel">SEAS</span></div>
    <div class="cell"><span id="gulfSeas">--</span></div>
    <div class="cell"><span id="baySeas">N/A</span></div>
    <div class="cell">SUNSET: <span id="sunset">--</span></div>

  </div>
</div>

<script>
/* GLOBALS */
const WORKER_URL="https://sta-spi.netlify.app/.netlify/functions/weather";
const NOAA_TIDE_STATION="8779750";
const LAT=26.07139, LON=-97.12872;

let offlineMode = false;
let offlineTime = null;
let lastLiveUpdate = null;

/* UTIL */
function pad(n){return String(n).padStart(2,"0");}
function toHM(d){return pad(d.getHours())+":"+pad(d.getMinutes());}
function pad(n){ return String(n).padStart(2,"0"); }
function toHM(d){ return pad(d.getHours())+":"+pad(d.getMinutes()); }

/* CLEAR ALERTS */
function clearAlerts(){
document.querySelectorAll('.alert-red,.alert-yellow')
.forEach(el=>el.classList.remove("alert-red","alert-yellow"));
  document.querySelectorAll('.alert-red,.alert-yellow')
    .forEach(el=>el.classList.remove("alert-red","alert-yellow"));
}

/* CLASS ADD */
function mark(id,cls){
document.getElementById(id).classList.add(cls);
  document.getElementById(id).classList.add(cls);
}

/* ALERT LOGIC */
/* ALERTS */
function applyAlertLogic(w){
clearAlerts();
const gw=w.gulf.waterF, bw=w.bay.waterF;
const ga=w.gulf.airF,   ba=w.bay.airF;
const seas=w.waves.waveFt;
  clearAlerts();

const waterLow = gw<60 || bw<60;
const airLow   = ga<60 || ba<60;
  const gw=w.gulf.waterF, bw=w.bay.waterF;
  const ga=w.gulf.airF,   ba=w.bay.airF;
  const seas=w.waves.waveFt;

if(waterLow){ mark("waterLabel","alert-red"); mark("gulfWater","alert-red"); mark("bayWater","alert-red"); }
  const waterLow = gw<60 || bw<60;
  const airLow   = ga<60 || ba<60;

if(airLow && !waterLow){
mark("airLabel","alert-yellow");
mark("gulfAir","alert-yellow");
mark("bayAir","alert-yellow");
}
  if(waterLow){
    mark("waterLabel","alert-red"); 
    mark("gulfWater","alert-red"); 
    mark("bayWater","alert-red");
  }

if(airLow && waterLow){
mark("airLabel","alert-red");
mark("gulfAir","alert-red");
mark("bayAir","alert-red");
}
  if(airLow && !waterLow){
    mark("airLabel","alert-yellow");
    mark("gulfAir","alert-yellow");
    mark("bayAir","alert-yellow");
  }

if(w.gulf.gustKts>=25 || w.bay.gustKts>=25 ||
w.gulf.windKts>=25 || w.bay.windKts>=25){
mark("windLabel","alert-red");
mark("gulfWind","alert-red");
mark("bayWind","alert-red");
}
  if(airLow && waterLow){
    mark("airLabel","alert-red");
    mark("gulfAir","alert-red");
    mark("bayAir","alert-red");
  }

if(seas>=8){
mark("seasLabel","alert-red");
mark("gulfSeas","alert-red");
}
else if(seas>=6){
mark("seasLabel","alert-yellow");
mark("gulfSeas","alert-yellow");
}
  if(w.gulf.gustKts>=25 || w.bay.gustKts>=25 ||
     w.gulf.windKts>=25 || w.bay.windKts>=25){
    mark("windLabel","alert-red");
    mark("gulfWind","alert-red");
    mark("bayWind","alert-red");
  }

  if(seas>=8){
    mark("seasLabel","alert-red");
    mark("gulfSeas","alert-red");
  } else if(seas>=6){
    mark("seasLabel","alert-yellow");
    mark("gulfSeas","alert-yellow");
  }
}

/* LIVE RENDER */
/* RENDER LIVE */
function renderLiveWeather(w){
gulfWater.textContent=w.gulf.waterF+"°F";
bayWater.textContent=w.bay.waterF+"°F";
gulfAir.textContent=w.gulf.airF+"°F";
bayAir.textContent=w.bay.airF+"°F";
  gulfWater.textContent = w.gulf.waterF + "°F";
  bayWater.textContent  = w.bay.waterF + "°F";
  gulfAir.textContent   = w.gulf.airF + "°F";
  bayAir.textContent    = w.bay.airF + "°F";

gulfWind.textContent=`${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
bayWind.textContent=`${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;
  gulfWind.textContent = `${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
  bayWind.textContent  = `${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;

gulfSeas.textContent = w.waves.waveFt!=null ? w.waves.waveFt+" ft" : "--";
  gulfSeas.textContent = w.waves.waveFt != null ? w.waves.waveFt+" ft" : "--";

applyAlertLogic(w);
  sunrise.textContent = w.sun.sunrise ?? "--";
  sunset.textContent  = w.sun.sunset ?? "--";

updatedAt.style.color="#e5e7eb";
updatedAt.textContent = "UPDATED " + toHM(lastLiveUpdate) + " LCL";
  tideLow.textContent  = w.tides.low  ? `${toHM(new Date(w.tides.low.t))} / ${(+w.tides.low.v).toFixed(1)} ft` : "--";
  tideHigh.textContent = w.tides.high ? `${toHM(new Date(w.tides.high.t))} / ${(+w.tides.high.v).toFixed(1)} ft` : "--";

  applyAlertLogic(w);

  updatedAt.style.color="#e5e7eb";
  updatedAt.textContent = "UPDATED " + toHM(lastLiveUpdate) + " LCL";
}

/* OFFLINE DISPLAY */
/* OFFLINE RENDER */
function applyOfflineDisplay(){
const cached = localStorage.getItem("lastWeather");
  const cached = localStorage.getItem("lastWeather");
const cachedTime = localStorage.getItem("lastWeatherTime");

if(!cached){
    updatedAt.textContent="OFFLINE";
  if(!cached){
    updatedAt.textContent="OFFLINE — NO CACHED DATA";
updatedAt.style.color="#facc15";
    updatedAt.textContent = "OFFLINE — NO CACHED DATA";
    updatedAt.style.color = "#facc15";
return;
}
    return;
  }

const w = JSON.parse(cached);
  const w = JSON.parse(cached);

  gulfWater.textContent=w.gulf.waterF+"°F";
  bayWater.textContent=w.bay.waterF+"°F";
  gulfAir.textContent=w.gulf.airF+"°F";
  bayAir.textContent=w.bay.airF+"°F";
  // Render cached values
gulfWater.textContent = w.gulf.waterF + "°F";
bayWater.textContent  = w.bay.waterF + "°F";
gulfAir.textContent   = w.gulf.airF + "°F";
bayAir.textContent    = w.bay.airF + "°F";

  gulfWind.textContent=`${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
  bayWind.textContent=`${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;
  gulfWind.textContent  = `${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
  bayWind.textContent   = `${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;
  gulfWind.textContent = `${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
  bayWind.textContent  = `${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;

  gulfSeas.textContent=w.waves.waveFt!=null ? w.waves.waveFt+" ft" : "--";
  gulfSeas.textContent  = w.waves.waveFt != null ? w.waves.waveFt + " ft" : "--";
  gulfSeas.textContent = w.waves.waveFt != null ? w.waves.waveFt + " ft" : "--";

applyAlertLogic(w);
  sunrise.textContent = w.sun.sunrise ?? "--";
  sunset.textContent  = w.sun.sunset ?? "--";

  updatedAt.style.color="#facc15";
  updatedAt.textContent = "OFFLINE";
  updatedAt.style.color = "#facc15";
  tideLow.textContent  = w.tides.low  ? `${toHM(new Date(w.tides.low.t))} / ${(+w.tides.low.v).toFixed(1)} ft` : "--";
  tideHigh.textContent = w.tides.high ? `${toHM(new Date(w.tides.high.t))} / ${(+w.tides.high.v).toFixed(1)} ft` : "--";

  if (cachedTime) {
    updatedAt.textContent = `OFFLINE — Last Live: ${cachedTime}`;
  } else {
    updatedAt.textContent = "OFFLINE — (no timestamp)";
  }
}
  applyAlertLogic(w);

  updatedAt.style.color="#facc15";
  updatedAt.textContent = cachedTime
    ? `OFFLINE — Last Live: ${cachedTime}`
    : "OFFLINE — (no timestamp)";
}

/* MAIN UPDATE */
function updateBoard(){
fetch(WORKER_URL)
.then(async r=>{
if(!r.ok) throw new Error();
const data = await r.json();

offlineMode = false;
offlineTime = null;
  fetch(WORKER_URL)
    .then(r => {
      if(!r.ok) throw new Error();
      return r.json();
    })
    .then(w => {
      offlineMode = false;

lastLiveUpdate = new Date();
      localStorage.setItem("lastWeather", JSON.stringify(data));
lastLiveUpdate = new Date();
localStorage.setItem("lastWeather", JSON.stringify(data));
localStorage.setItem("lastWeatherTime", toHM(lastLiveUpdate));


renderLiveWeather(data);
})
.catch(()=>{
if(!offlineMode){
offlineMode = true;
offlineTime = new Date();
}
applyOfflineDisplay();
});

if(!offlineMode){
fetchTides();
fetchSun();
}

updateDate();
}
      localStorage.setItem("lastWeather", JSON.stringify(w));
      localStorage.setItem("lastWeatherTime", toHM(lastLiveUpdate));

/* TIDES */
function fetchTides(){
fetch(`https://api.tidesandcurrents.noaa.gov/api/prod/datagetter?product=predictions&station=${NOAA_TIDE_STATION}&date=today&interval=hilo&units=english&time_zone=lst_ldt&datum=MLLW&format=json`)
.then(r=>r.json())
.then(t=>{
const low=t.predictions.find(x=>x.type==="L");
const high=t.predictions.find(x=>x.type==="H");

tideLow.textContent = low ? `${toHM(new Date(low.t))} / ${(+low.v).toFixed(1)} ft` : "--";
tideHigh.textContent = high? `${toHM(new Date(high.t))} / ${(+high.v).toFixed(1)} ft` : "--";
});
}
      renderLiveWeather(w);
    })
    .catch(() => {
      offlineMode = true;
      applyOfflineDisplay();
    });

/* SUN TIMES */
function fetchSun(){
fetch(`https://api.sunrise-sunset.org/json?lat=${LAT}&lng=${LON}&formatted=0`)
.then(r=>r.json())
.then(s=>{
sunrise.textContent = toHM(new Date(s.results.sunrise));
sunset.textContent  = toHM(new Date(s.results.sunset));
});
  updateDate();
}

/* DATE */
function updateDate(){
const now=new Date();
const dd=pad(now.getDate());
const mm=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][now.getMonth()];
const yy=String(now.getFullYear()).slice(2);
  const now=new Date();
  const dd=pad(now.getDate());
  const mm=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][now.getMonth()];
  const yy=String(now.getFullYear()).slice(2);

tideDate.textContent=`${dd} ${mm} ${yy}`;
  tideDate.textContent=`${dd} ${mm} ${yy}`;
}

/* START — immediate load */
/* INITIAL LOAD */
updateBoard();

/* WAIT FOR NEXT MINUTE, THEN REFRESH EVERY 60s */
/* SYNC EVERY MINUTE */
(function syncToMinute(){
const now = new Date();
const msUntilNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();

setTimeout(()=>{
updateBoard();
setInterval(updateBoard, 60000);
}, msUntilNextMinute);
  const now = new Date();
  const ms = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
  setTimeout(()=>{
    updateBoard();
    setInterval(updateBoard, 60000);
  }, ms);
})();

/* LIVE CLOCK UPDATER */
setInterval(()=>{
if(!offlineMode && lastLiveUpdate){
updatedAt.textContent = "UPDATED " + toHM(lastLiveUpdate) + " LCL";
}
},1000);

</script>

</body>
