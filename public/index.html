<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SPI Marine Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#020617;
  --text:#e5e7eb;
  --mono:"SF Mono",Menlo,Consolas,monospace;
  --alert-red:#7f1d1d;
  --alert-yellow:#facc15;
}

body{
  margin:0;
  background:#020617;
  color:var(--text);
  font-family:var(--mono);
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

.board{
  width:100%;
  height:100%;
  padding:4vh 4vw;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  gap:5vh;
}

.title{
  display:flex;
  justify-content:space-evenly;
  font-size:clamp(2rem,4vw,4rem);
}

.grid{
  flex:1;
  display:grid;
  grid-template-columns:1fr 1fr 1fr 1fr;
  gap:4vh 4vw;
  font-size:clamp(1.4rem,2.8vw,3.2rem);
}

.cell { white-space:nowrap; }

.alert-red, .alert-yellow{
  padding:0.25em 0.4em;
  border-radius:6px;
  color:black !important;
}
.alert-red{ background:var(--alert-red); }
.alert-yellow{ background:var(--alert-yellow); }

</style>
</head>

<body>
<div class="board">

  <div class="title">
    <div>WEATHER</div>
    <div id="updatedAt">LOADING…</div>
  </div>

  <div class="grid">
    <div></div>
    <div>GULF</div>
    <div>BAY</div>
    <div>TIDES: <span id="tideDate"></span></div>

    <div><span id="waterLabel">WATER</span></div>
    <div id="gulfWater">--</div>
    <div id="bayWater">--</div>
    <div>LOW: <span id="tideLow">--</span></div>

    <div><span id="airLabel">AIR</span></div>
    <div id="gulfAir">--</div>
    <div id="bayAir">--</div>
    <div>HIGH: <span id="tideHigh">--</span></div>

    <div><span id="windLabel">WIND</span></div>
    <div id="gulfWind">--</div>
    <div id="bayWind">--</div>
    <div>SUNRISE: <span id="sunrise">--</span></div>

    <div><span id="seasLabel">SEAS</span></div>
    <div id="gulfSeas">--</div>
    <div id="baySeas">N/A</div>
    <div>SUNSET: <span id="sunset">--</span></div>
  </div>

</div>

<script>
const WORKER_URL = "https://sta-spi.netlify.app/.netlify/functions/weather";

function pad(n){ return String(n).padStart(2,"0"); }
function toHM(d){ return pad(d.getHours())+":"+pad(d.getMinutes()); }

function renderTide(obj){
  if (!obj) return "--";
  return `${obj.time}  ${obj.v}ft`;
}

function render(w){
  gulfWater.textContent = w.gulf.waterF+"°F";
  bayWater.textContent  = w.bay.waterF +"°F";

  gulfAir.textContent = w.gulf.airF+"°F";
  bayAir.textContent  = w.bay.airF +"°F";

  gulfWind.textContent = `${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
  bayWind.textContent  = `${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;

  gulfSeas.textContent = w.waves.waveFt != null ? w.waves.waveFt+" ft" : "--";

  tideLow.textContent  = renderTide(w.tides.low);
  tideHigh.textContent = renderTide(w.tides.high);

  sunrise.textContent = w.sun.sunrise ?? "--";
  sunset.textContent  = w.sun.sunset ?? "--";

  updatedAt.textContent = "UPDATED " + toHM(new Date());
}

function updateDate(){
  const now = new Date();
  tideDate.textContent =
    `${pad(now.getDate())} ` +
    ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][now.getMonth()] +
    ` ${String(now.getFullYear()).slice(2)}`;
}

function update(){
  fetch(WORKER_URL)
    .then(r=>r.json())
    .then(w=>{
      render(w);
      localStorage.setItem("lastWeather",JSON.stringify(w));
    })
    .catch(()=>{
      const cached = localStorage.getItem("lastWeather");
      if(cached) render(JSON.parse(cached));
      updatedAt.textContent = "OFFLINE";
    });

  updateDate();
}

function start(){
  update();
  setInterval(update, 6*60*1000);
}

start();
</script>

</body>
</html>
