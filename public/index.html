<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SPI Marine Board</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg:#020617;
  --text:#e5e7eb;
  --border:#1f2937;
  --mono:"SF Mono",Menlo,Consolas,monospace;
  --alert-red:#7f1d1d;
  --alert-yellow:#facc15;
}

body {
  margin:0;
  width:100vw;
  height:100vh;
  overflow:hidden;
  background:radial-gradient(circle at top,#1e293b 0,#020617 55%);
  color:var(--text);
  font-family:var(--mono);
  display:flex;
  justify-content:center;
  align-items:center;
}

.board {
  width:100%;
  height:100%;
  padding:4vh 4vw;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
  gap:5vh;
}

/* FIXED – Title spacing no longer hits walls */
.title {
  display:flex;
  justify-content:space-evenly;
  align-items:center;
  font-size:clamp(2rem,4vw,4rem);
  padding-left:3vw;
  padding-right:3vw;
}

.grid {
  flex:1;
  width:100%;
  display:grid;
  grid-template-columns:1fr 1fr 1fr 1fr;
  row-gap:4vh;
  column-gap:4vw;
  font-size:clamp(1.4rem,2.8vw,3.2rem);
}

.cell { white-space:nowrap; }

.alert-red, .alert-yellow {
  padding:0.25em 0.4em;
  border-radius:6px;
  width:100%;
  display:inline-block;
  color:black !important;
}
.alert-red { background:var(--alert-red); }
.alert-yellow { background:var(--alert-yellow); }
</style>
</head>

<body>
<div class="board">
  <div class="title">
    <div>WEATHER</div>
    <div id="updatedAt">LOADING…</div>
  </div>

  <div class="grid">
    <div class="cell"></div>
    <div class="cell">GULF</div>
    <div class="cell">BAY</div>
    <div class="cell">TIDES: <span id="tideDate"></span></div>

    <div class="cell"><span id="waterLabel">WATER</span></div>
    <div class="cell"><span id="gulfWater">--</span></div>
    <div class="cell"><span id="bayWater">--</span></div>
    <div class="cell">LOW: <span id="tideLow">--</span></div>

    <div class="cell"><span id="airLabel">AIR</span></div>
    <div class="cell"><span id="gulfAir">--</span></div>
    <div class="cell"><span id="bayAir">--</span></div>
    <div class="cell">HIGH: <span id="tideHigh">--</span></div>

    <div class="cell"><span id="windLabel">WIND</span></div>
    <div class="cell"><span id="gulfWind">--</span></div>
    <div class="cell"><span id="bayWind">--</span></div>
    <div class="cell">SUNRISE: <span id="sunrise">--</span></div>

    <div class="cell"><span id="seasLabel">SEAS</span></div>
    <div class="cell"><span id="gulfSeas">--</span></div>
    <div class="cell"><span id="baySeas">N/A</span></div>
    <div class="cell">SUNSET: <span id="sunset">--</span></div>
  </div>
</div>

<script>
/* ===========================
   PRODUCTION BACKEND URL
   =========================== */
const WORKER_URL="https://sta-spi.netlify.app/.netlify/functions/weather";

/* UTIL */
let lastLiveUpdate = null;

function pad(n){ return String(n).padStart(2,"0"); }
function toHM(d){ return pad(d.getHours())+":"+pad(d.getMinutes()); }

/* Convert sunrise/sunset */
function convertToLocal24(timeStr, forcePM=false){
  if(!timeStr) return "--";
  let [h, m] = timeStr.split(":").map(Number);
  if(forcePM && h < 12) h += 12;
  return pad(h)+":"+pad(m);
}

/* Convert UTC tide timestamp -> LOCAL */
function formatTide(t){
  if(!t) return "--";
  let d = new Date(t.t);                    // t.t is UTC
  let local = new Date(d.getTime() + (d.getTimezoneOffset() * -60000));
  return `${pad(local.getHours())}:${pad(local.getMinutes())}  ${t.v}ft`;
}

/* ALERTS */
function clearAlerts(){
  document.querySelectorAll('.alert-red,.alert-yellow')
    .forEach(el => el.classList.remove("alert-red","alert-yellow"));
}
function mark(id,cls){
  document.getElementById(id).classList.add(cls);
}

function applyAlertLogic(w){
  clearAlerts();
  const gw=w.gulf.waterF, bw=w.bay.waterF;
  const ga=w.gulf.airF,   ba=w.bay.airF;
  const seas=w.waves.waveFt;

  const waterLow=(gw<60||bw<60);
  const airLow=(ga<60||ba<60);

  if(waterLow){
    mark("waterLabel","alert-red");
    mark("gulfWater","alert-red");
    mark("bayWater","alert-red");
  }
  if(airLow && !waterLow){
    mark("airLabel","alert-yellow");
    mark("gulfAir","alert-yellow");
    mark("bayAir","alert-yellow");
  }
  if(airLow && waterLow){
    mark("airLabel","alert-red");
    mark("gulfAir","alert-red");
    mark("bayAir","alert-red");
  }

  if(w.gulf.gustKts>=25||w.bay.gustKts>=25||
     w.gulf.windKts>=25||w.bay.windKts>=25){
    mark("windLabel","alert-red");
    mark("gulfWind","alert-red");
    mark("bayWind","alert-red");
  }

  if(seas>=8){
    mark("seasLabel","alert-red");
    mark("gulfSeas","alert-red");
  } else if(seas>=6){
    mark("seasLabel","alert-yellow");
    mark("gulfSeas","alert-yellow");
  }
}

/* RENDER */
function renderLiveWeather(w){
  gulfWater.textContent = w.gulf.waterF+"°F";
  bayWater.textContent  = w.bay.waterF+"°F";

  gulfAir.textContent = w.gulf.airF+"°F";
  bayAir.textContent  = w.bay.airF+"°F";

  gulfWind.textContent = `${w.gulf.windKts}-${w.gulf.gustKts} kts ${w.gulf.windDirCardinal}`;
  bayWind.textContent  = `${w.bay.windKts}-${w.bay.gustKts} kts ${w.bay.windDirCardinal}`;

  gulfSeas.textContent = w.waves.waveFt!=null ? w.waves.waveFt+" ft" : "--";

  sunrise.textContent = convertToLocal24(w.sun.sunrise, false);
  sunset.textContent  = convertToLocal24(w.sun.sunset, true);  // always PM

  tideLow.textContent  = formatTide(w.tides.low);
  tideHigh.textContent = formatTide(w.tides.high);

  applyAlertLogic(w);

  updatedAt.style.color="#e5e7eb";
  updatedAt.textContent="UPDATED " + toHM(lastLiveUpdate);
}

/* OFFLINE */
function applyOfflineDisplay(){
  const cached=localStorage.getItem("lastWeather");
  const time=localStorage.getItem("lastWeatherTime");

  if(!cached){
    updatedAt.textContent="OFFLINE — NO CACHED DATA";
    updatedAt.style.color="#facc15";
    return;
  }

  renderLiveWeather(JSON.parse(cached));
  updatedAt.style.color="#facc15";
  updatedAt.textContent="OFFLINE — Last Live: "+(time??"UNKNOWN");
}

/* MAIN FETCH */
function updateBoard(){
  fetch(WORKER_URL)
    .then(r => { if(!r.ok) throw Error(); return r.json(); })
    .then(w => {
      lastLiveUpdate=new Date();
      localStorage.setItem("lastWeather",JSON.stringify(w));
      localStorage.setItem("lastWeatherTime",toHM(lastLiveUpdate));
      renderLiveWeather(w);
    })
    .catch(()=>applyOfflineDisplay());

  updateDate();
}

function updateDate(){
  const now=new Date();
  const dd=pad(now.getDate());
  const mm=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][now.getMonth()];
  tideDate.textContent=`${dd} ${mm} ${String(now.getFullYear()).slice(2)}`;
}

/* SYNC TO 6-MINUTE MARKS */
function syncTo6Min(){
  const now = new Date();
  const minute = now.getMinutes();
  const next = Math.ceil(minute / 6) * 6;

  const target = new Date(now);
  target.setMinutes(next);
  target.setSeconds(0);
  target.setMilliseconds(0);

  const ms = target - now;

  setTimeout(()=>{
    updateBoard();
    setInterval(updateBoard, 6*60*1000); // 6 min
  }, ms);
}

updateBoard();
syncTo6Min();
</script>

</body>
</html>
